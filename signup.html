<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cool Invoice</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/logo/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500&family=Roboto:wght@500;700&display=swap" rel="stylesheet">  

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="fonts/icomoon/style.css">

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->
    <!-- Nice Select CSS -->
    <!-- <link rel="stylesheet" href="css/nice-select.css"> -->
    <!-- Font Awesome CSS -->
    <!-- <link rel="stylesheet" href="css/font-awesome.min.css"> -->
    <!-- icofont CSS -->
    <link rel="stylesheet" href="css/icofont.css">
    <!-- Slicknav -->
    <!-- <link rel="stylesheet" href="css/slicknav.min.css"> -->
    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="css/owl-carousel.css">
    <!-- Datepicker CSS -->
    <!-- <link rel="stylesheet" href="css/datepicker.css"> -->
    <!-- Animate CSS -->
    <!-- <link rel="stylesheet" href="css/animate.min.css"> -->
    <!-- Magnific Popup CSS -->
    <!-- <link rel="stylesheet" href="css/magnific-popup.css"> -->


    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <!-- <link href="css/style.bundle.css" rel="stylesheet"> -->
    <!-- <link href="css/normalize.css" rel="stylesheet"> -->
    <link href="css/login.css" rel="stylesheet">

    <style>
      /* full‑screen translucent overlay, hidden by default */
      #loaderOverlay {
        display: none; /* ensure hidden until shown via JS */
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(255,255,255,0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        /* use flex via CSS, not Bootstrap class */
        display: flex;
      }
      /* classic CSS spinner */
      .loader {
        border: 12px solid #f3f3f3;
        border-top: 12px solid #3498db;
        border-radius: 50%;
        width: 80px; height: 80px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0%   { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>

  <body>

    <div id="loaderOverlay">
      <div class="loader"></div>
    </div>

    <div class="d-lg-flex half">

      <div class="contents order-2 order-md-2">
        <div class="container">
          <div class="row align-items-center justify-content-center">
            <div class="col-md-7">
              <div class="mb-4">
                <h3>Sign Up</h3>
                <p class="mb-4">Invoice Management System</p>
              </div>
              <form action="#" method="post">
                <!-- <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="name" placeholder="name@example.com">
                  <label for="name">Company Name</label>
                </div> -->

                <!-- <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="floatingInput" placeholder="name@example.com">
                  <label for="floatingInput">First Name</label>
                </div>

                <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="floatingInput" placeholder="name@example.com">
                  <label for="floatingInput">Last Name</label>
                </div> -->
                
                <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="email" placeholder="name@example.com">
                  <label for="email">Email address</label>
                </div>

                <!-- <div class="form-floating mb-3">
                  <input type="email" class="form-control" id="floatingInput" placeholder="name@example.com">
                  <label for="floatingInput">Phone</label>
                </div> -->

                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="password" placeholder="Password">
                  <label for="password">Password</label>
                </div>

                <!-- <div class="form-floating mb-3">
                  <textarea class="form-control" placeholder="Address" id="floatingTextarea2" style="height: 100px"></textarea>
                  <label for="floatingTextarea2">Address</label>
                </div> -->

                <input type="submit" value="Sign Up" class="btn btn-block btn-primary w-100">
              </form>

              <!-- use data-client_id for company email-->
              <div
                  id="g_id_onload"
                  data-client_id="214324501398-6dhagfs6iv4fab0agsf8fs0c9oq5f2m4.apps.googleusercontent.com"
                  data-context="signin"
                  data-ux_mode="popup"
                  data-callback="handleCredentialResponse"
                  data-auto_prompt="false"
                  class="mt-2"
                ></div>

                <div
                  class="g_id_signin"
                  data-type="standard"
                  data-size="large"
                  data-theme="outline"
                  data-text="sign_in_with"
                  data-shape="rectangular"
                  data-logo_alignment="center"
                ></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg order-1 order-md-1" style="background-image: url('img/login-bg_1.jpg');"></div>

    </div>
    
    <!-- JavaScript Libraries -->
    <!-- <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script> -->
    <script src="lib/wow/wow.min.js"></script>
    <!-- <script src="lib/easing/easing.min.js"></script> -->
    <!-- <script src="lib/waypoints/waypoints.min.js"></script> -->
    <!-- <script src="lib/owlcarousel/owl.carousel.min.js"></script> -->
    <!-- Owl Carousel JS -->
    <!-- <script src="js/owl-carousel.js"></script> -->
    <!-- <script src="lib/counterup/counterup.min.js"></script> -->

    <!-- jquery Min JS -->
    <script src="js/jquery.min.js"></script>
    <!-- jquery Migrate JS -->
    <script src="js/jquery-migrate-3.0.0.js"></script>
    <!-- jquery Ui JS -->
    <!-- <script src="js/jquery-ui.min.js"></script> -->
    <!-- Easing JS -->
    <!-- <script src="js/easing.js"></script> -->
    <!-- Color JS -->
    <!-- <script src="js/colors.js"></script> -->
    <!-- Popper JS -->
    <script src="js/popper.min.js"></script>
    <!-- Bootstrap Datepicker JS -->
    <!-- <script src="js/bootstrap-datepicker.js"></script> -->
    <!-- Jquery Nav JS -->
    <!-- <script src="js/jquery.nav.js"></script> -->
    <!-- Slicknav JS -->
    <!-- <script src="js/slicknav.min.js"></script> -->
    <!-- ScrollUp JS -->
    <!-- <script src="js/jquery.scrollUp.min.js"></script> -->
    <!-- Niceselect JS -->
    <!-- <script src="js/niceselect.js"></script> -->
    <!-- Tilt Jquery JS -->
    <!-- <script src="js/tilt.jquery.min.js"></script> -->
    <!-- Owl Carousel JS -->
    <script src="js/owl-carousel.js"></script>
    <!-- counterup JS -->
    <script src="js/jquery.counterup.min.js"></script>
    <!-- Steller JS -->
    <!-- <script src="js/steller.js"></script> -->
    <!-- Wow JS -->
    <!-- <script src="js/wow.min.js"></script> -->
    <!-- Magnific Popup JS -->
    <!-- <script src="js/jquery.magnific-popup.min.js"></script> -->
    <!-- Counter Up CDN JS -->
    <!-- <script src="http://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.3/waypoints.min.js"></script> -->
    <!-- Bootstrap JS -->
    <script src="js/bootstrap.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>


    <!-- Template Javascript -->
    <!-- <script src="js/login.js"></script> -->
     
    <!-- Include jQuery via CDN (place this before any script that uses it) -->
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->

    <!-- old code for directly sign in blazor app -->
    <!-- <script>
      $(document).ready(function () {
        $('form').on('submit', function (e) {
          e.preventDefault();
    
          const name = $('#name').val();
          const email = $('#email').val();
          const password = $('#password').val();
    
          // Simple validation
          if (!name || !email || !password) {
            alert('Please fill in all fields.');
            return;
          }
    
          //payload 
          const payload = {
            //CompanyName: name,
            Name: name,
            CompanyEmail: email,
            Password: password,
            UserType: 2, //  2 is for "CompanyAdmin". check the database table for other user types.
            IsVerified: false,
          };

          console.log('Payload:', payload);
    
          $.ajax({
            //url: 'https://localhost:7170/api/SignUp/SignUp',
            url: 'https://localhost:7170/api/Email/SendEmail',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (response) {
              console.log('Success:', response);
              alert('We send an Email. Please Check your Inbox or Spam folder to verify your account.');
              // Open the Blazor app 
              //window.open('https://localhost:7007', '_blank');
              //window.open('https://localhost:7170/api/Email/SendEmail', '_blank');
            },
            error: function (xhr, status, error) {
              console.error('Error:', error);
              console.log('XHR:', xhr);
              console.log('Status:', status);
              console.log('Response:', xhr.responseText);
              alert('Signup failed: ' + xhr.responseText);
            }
          });
        });
      });
    </script> -->
    
    <script>
      let googleUserName = "";
    
      $(document).ready(function () {
        $('#loaderOverlay').hide();
        // form submit
        $('form').on('submit', function (e) {
          e.preventDefault();
          sendConfirmationEmail();
        });
      });

      // shared function to send confirmation email
      function sendConfirmationEmail() {
        const email    = $('#email').val();
        const password = $('#password').val();
    
        // if no password AND no googleUserName, require fill
        if (!email || (!password && !googleUserName)) {
          alert('Please fill in all fields (or sign in with Google).');
          return;
        }

            // derive a displayName:
            //  - if Google signup, use that
            //  - otherwise take local‑part of email and strip out digits/other chars
            let displayName = googleUserName || "";
            if (!displayName) {
              const localPart = email.split('@')[0] || "";
              // remove anything that's not A–Z or a–z
              const justLetters = localPart.replace(/[^a-zA-Z]/g, '');
              displayName = justLetters || localPart; 
            }

        // 256‑bit key must match on server
          const secretKey = CryptoJS.enc.Utf8.parse("0123456789abcdef0123456789abcdef");
          const iv        = CryptoJS.enc.Utf8.parse("abcdef9876543210"); // 16‑byte IV

          // Encrypt the password
          const encrypted = CryptoJS.AES.encrypt(
            password,
            secretKey,
            { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }
          ).toString();    // Base64 ciphertext
    
        // const confirmLink = 
        //   `https://localhost:7170/api/Email/ConfirmEmail?` +
        //   `email=${encodeURIComponent(email)}&isConfirm=true`;
        // build confirm link with email, password, isConfirm=true
        const confirmLink =
          `https://localhost:7170/api/Email/ConfirmEmail?` +
          `email=${encodeURIComponent(email)}` +
          `&pwd=${encodeURIComponent(encrypted || "")}` +
          `&isConfirm=true`;
    
        const emailPayload = {
          toEmail: email,
          subject: 'Welcome to Cool Invoice! Confirm Your Email to get Started',
          body: `
          <div style="font-family: Arial, sans-serif; background:#f5f5f5; padding:30px;">
            <div style="
                max-width:600px; margin:0 auto; background:#fff;
                border:1px solid #ddd; border-radius:8px;
                box-shadow:0 2px 8px rgba(0,0,0,0.05); padding:20px;">
              <h2 style="text-align:center; color:#333; margin-bottom:20px;">
                Welcome to Cool Invoice!
              </h2>
              <p style="color:#555; line-height:1.6; font-size:16px; text-align:center;">
                Hi ${displayName || ''},
              </p>
              <p style="color:#555; line-height:1.6;">
                Thank you for signing up! 
              </p>
              <p style="color:#555; line-height:1.6;">
                We're excited to help you simplify your invoicing and streamline your business operations. To activate your account, please confirm your email address by clicking the button below:
              </p>
              <div style="text-align:center; margin:30px 0;">
                <a href="${confirmLink}" style="
                   display:inline-block; padding:12px 24px; font-size:16px;
                   font-weight:bold; color:#000; background-color:#00ffff;
                   text-decoration:none; border-radius:4px;">
                  Confirm My Email
                </a>
              </div>
              <p style="color:#df5858; font-size:14px; line-height:1.4;">
                If you didn’t create an account, you can safely ignore this email.
              </p>
              <hr style="border:none; border-top:1px solid #eee; margin:20px 0;" />
              <p style="color:#777; font-size:14px; text-align:center;">
                kind regards,<br/>
                <strong>The Cool Invoice Team</strong><br/>
                <a href="http://coolinvoice.com" style="color:#1ba9a9; text-decoration:none;">
                  coolinvoice.com
                </a>
              </p>
            </div>
          </div>`
        };
    
        // show loader
        $('#loaderOverlay').show();
    
        // send email
        $.ajax({
          url: 'https://localhost:7170/api/Email/SendEmail',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(emailPayload),
          success: function () {
            alert('We sent an email. Please check your inbox or spam folder.');
          },
          error: function (xhr) {
            alert('Failed to send confirmation email: ' + xhr.responseText);
          },
          complete: function() {
            // hide loader once done
            $('#loaderOverlay').hide();
          }
        });
      }
    

    </script>
    
    <!-- 3) Google Sign‑In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
      function handleCredentialResponse(response) {
        const payload = JSON.parse(atob(response.credential.split(".")[1]));
        if (payload) {
          $('#email').val(payload.email);
          googleUserName = payload.name || '';
          // directly send email once Google identity obtained
          sendConfirmationEmail();
        }
      }
    </script>
    
  </body>
</html>